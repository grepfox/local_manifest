#!/bin/bash

# Remove old local manifests
rm -rf .repo/local_manifests

# Nuke trees
rm -rf vendor/xiaomi/vayu
rm -rf device/xiaomi/vayu

# Initialize repo with YAAP manifest
repo init -u https://github.com/yaap/manifest -b sixteen --git-lfs --depth=1

# Clone local manifests
git clone https://github.com/grepfox/local_manifest -b yaap .repo/local_manifests

# Remove old prebuilts and hardware directories
rm -rf prebuilts/clang/host/linux-x86

# Remove hardware repos
rm -rf hardware

# Run resync script
/opt/crave/resync.sh

# Replace lineage compat
rm -rf hardware/lineage/compat
git clone https://github.com/grepfox/hardware_lineage_compat hardware/lineage/compat

# Clean and replace more directories
rm -rf prebuilts/clang/host/linux-x86
rm -rf hardware/xiaomi
git clone https://github.com/yaap/hardware_xiaomi hardware/xiaomi -b sixteen

# Clone clang prebuilts
git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 --single-branch -b android-16.0.0_r1 prebuilts/clang/host/linux-x86

# Replace vendor/yaap
rm -rf vendor/yaap
git clone https://github.com/grepfox/vendor_yaap -b sixteen-staging --depth=1 vendor/yaap
rm -rf vendor/yaap/signing/keys
git clone https://$GH_TOKEN@github.com/grepfox/yaap_sign vendor/yaap/signing/keys

# Source environment and lunch target
source build/envsetup.sh
lunch yaap_vayu-user

# Start the build
m installclean
m yaap

# Clean up
rm -rf prebuilts/clang/host/linux-x86
rm -rf vendor/yaap
rm -rf vendor/yaap/signing/keys

# Display any error logs
echo "Here is your error"
cat out/error.log
