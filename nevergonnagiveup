#!/bin/bash

echo "========================================"
echo "      STARTING YAAP BUILD SCRIPT        "
echo "========================================"

echo "========== REMOVING OLD LOCAL MANIFESTS =========="
rm -rf .repo/local_manifests

echo "========== NUKING OLD STUFF =========="
rm -rf vendor/xiaomi/vayu
rm -rf device/xiaomi/vayu
rm -rf vendor/yaap
rm -rf prebuilts/clang/host/linux-x86

echo "========== INITIALIZING REPO WITH YAAP MANIFEST =========="
repo init -u https://github.com/yaap/manifest -b sixteen --git-lfs --depth=1

echo "========== CLONING LOCAL MANIFESTS =========="
git clone https://github.com/grepfox/local_manifest -b yaap .repo/local_manifests

echo "========== REMOVING OLD PREBUILTS AND HARDWARE REPOS =========="
rm -rf prebuilts/clang/host/linux-x86
rm -rf hardware

echo "========== RUNNING SYNC SCRIPT =========="

if [ -f /opt/crave/resync.sh ]; then
    /opt/crave/resync.sh
else
    repo sync -j8 --force-sync
fi


echo "========== CLEANING AND REPLACING DIRECTORIES =========="
rm -rf hardware/xiaomi

echo "========== CLONING XIAOMI HARDWARE =========="
git clone https://github.com/yaap/hardware_xiaomi hardware/xiaomi -b sixteen

# DisplayFeatures
# echo "========== CLONING DISPLAYFEATURES APP =========="
# rm -rf packages/apps/DisplayFeatures
# git clone https://github.com/cyberknight777/android_packages_apps_DisplayFeatures packages/apps/DisplayFeatures -b master

#echo "========== CLONING CLANG PREBUILTS =========="
#git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 --single-branch -b android-16.0.0_r1 prebuilts/clang/host/linux-x86

echo "========== REPLACING YAAP VENDOR REPO =========="
rm -rf vendor/yaap
git clone https://github.com/yaap/vendor_yaap -b sixteen-staging --depth=1 --single-branch vendor/yaap

echo "========== CLONING SIGNING KEYS =========="
rm -rf vendor/yaap/signing/keys
git clone https://$GH_TOKEN@github.com/grepfox/yaap_sign vendor/yaap/signing/keys

echo "========== REPLACING FWB AND SETTINGS =========="
rm -rf packages/apps/Settings
git clone https://github.com/sm8150-playground/packages_apps_Settings -b sixteen --depth=1 --single-branch packages/apps/Settings
rm -rf packages/apps/Settings/.git
git clone https://github.com/yaap/packages_apps_YASP packages/apps/Settings/YASP

echo "========== SOURCING BUILD ENVIRONMENT =========="
source build/envsetup.sh

# Optional YAAP build type
export YAAP_BUILDTYPE=Banshee

echo "========== SETTING BUILD TARGET AND OPTIONS =========="
export TARGET_BUILD_GAPPS=true
lunch yaap_vayu-user

echo "========== CLEANING PREVIOUS BUILD ARTIFACTS =========="
m installclean

echo "========== STARTING YAAP BUILD =========="
m yaap

export YAAP_BUILDTYPE=Vanilla
export TARGET_BUILD_GAPPS=false
m yaap

echo "========== CLEANING UP REPOS AFTER BUILD =========="
rm -rf prebuilts/clang/host/linux-x86
rm -rf vendor/yaap
rm -rf vendor/yaap/signing/keys
rm -rf vendor/themes
rm -rf frameworks/base

echo "========== BUILD COMPLETE - CHECKING FOR ERRORS =========="
if [ -f out/error.log ]; then
    cat out/error.log
else
    echo "NO ERROR LOG FOUND - BUILD COMPLETED SUCCESSFULLY"
fi

echo "========== Sharing output dir ls =========="
ls out/target/product/vayu

echo "========================================"
echo "        YAAP BUILD DONE          "
echo "========================================"
